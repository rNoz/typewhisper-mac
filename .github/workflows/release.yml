name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  SCHEME: TypeWhisper
  PROJECT: TypeWhisper.xcodeproj

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project $PROJECT \
            -scheme $SCHEME

      - name: Import Signing Certificate
        env:
          MACOS_SIGNING_P12: ${{ secrets.MACOS_SIGNING_P12 }}
          MACOS_SIGNING_PASSWORD: ${{ secrets.MACOS_SIGNING_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/typewhisper-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          echo "$MACOS_SIGNING_P12" | base64 --decode > /tmp/cert.p12

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import /tmp/cert.p12 -k "$KEYCHAIN_PATH" -P "$MACOS_SIGNING_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: Build App
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          VERSION="${VERSION%%-*}"
          echo "Building version: $VERSION"

          xcodebuild -project $PROJECT \
            -scheme $SCHEME \
            -configuration Release \
            -derivedDataPath build \
            -destination 'generic/platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION="$VERSION" \
            CURRENT_PROJECT_VERSION="$VERSION"

      - name: Sign App (Developer ID)
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          cd build/Build/Products/Release
          find TypeWhisper.app -name '._*' -delete
          xattr -cr TypeWhisper.app
          codesign --force --deep --options runtime --timestamp \
            --entitlements "${GITHUB_WORKSPACE}/TypeWhisper/Resources/TypeWhisper.entitlements" \
            --sign "$MACOS_SIGNING_IDENTITY" \
            TypeWhisper.app
          codesign --verify --deep --strict --verbose=2 TypeWhisper.app

      - name: Notarize App
        env:
          APPLE_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APPLE_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          printf '%s' "$APPLE_API_KEY_P8" > /tmp/AuthKey.p8
          chmod 600 /tmp/AuthKey.p8

          cd build/Build/Products/Release
          ditto -c -k --keepParent TypeWhisper.app TypeWhisper-notarize.zip

          xcrun notarytool submit TypeWhisper-notarize.zip \
            --key /tmp/AuthKey.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --wait

          xcrun stapler staple TypeWhisper.app
          rm -f TypeWhisper-notarize.zip

      - name: Install dmgbuild
        run: |
          VENV_DIR="${RUNNER_TEMP}/dmgbuild-venv"
          python3 -m venv "$VENV_DIR"
          source "$VENV_DIR/bin/activate"
          python -m pip install --upgrade pip
          python -m pip install dmgbuild
          echo "$VENV_DIR/bin" >> $GITHUB_PATH

      - name: Create DMG
        run: |
          TAG="${{ github.ref_name }}"
          APP_NAME="TypeWhisper"
          DMG_NAME="TypeWhisper-${TAG}.dmg"
          APP_PATH="build/Build/Products/Release/TypeWhisper.app"
          SETTINGS="${GITHUB_WORKSPACE}/.github/dmgbuild-settings.py"
          BACKGROUND="${GITHUB_WORKSPACE}/.github/dmg-background.png"

          dmgbuild -s "$SETTINGS" \
            -D app="$APP_NAME" \
            -D app_path="$APP_PATH" \
            -D background="$BACKGROUND" \
            "$APP_NAME" \
            "build/Build/Products/Release/${DMG_NAME}"

      - name: Notarize DMG
        env:
          APPLE_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APPLE_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          if [ ! -f /tmp/AuthKey.p8 ]; then
            printf '%s' "$APPLE_API_KEY_P8" > /tmp/AuthKey.p8
            chmod 600 /tmp/AuthKey.p8
          fi

          DMG_PATH="build/Build/Products/Release/TypeWhisper-${{ github.ref_name }}.dmg"
          xcrun notarytool submit "$DMG_PATH" \
            --key /tmp/AuthKey.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --wait

          xcrun stapler staple "$DMG_PATH"

      - name: Create ZIP
        run: |
          cd build/Build/Products/Release
          ditto -c -k --keepParent TypeWhisper.app TypeWhisper-${{ github.ref_name }}.zip

      - name: Cleanup Signing Assets
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          rm -f /tmp/AuthKey.p8 /tmp/cert.p12

      - name: Sign ZIP with Sparkle EdDSA
        env:
          SPARKLE_EDDSA_KEY: ${{ secrets.SPARKLE_EDDSA_KEY }}
        run: |
          TAG="${{ github.ref_name }}"
          ZIP_PATH="build/Build/Products/Release/TypeWhisper-${TAG}.zip"

          # Download Sparkle CLI tools
          SPARKLE_VERSION="2.8.1"
          curl -L "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz" -o /tmp/sparkle.tar.xz
          mkdir -p /tmp/sparkle
          tar -xf /tmp/sparkle.tar.xz -C /tmp/sparkle

          # Sign the ZIP
          SIGNATURE=$(/tmp/sparkle/bin/sign_update "$ZIP_PATH" --ed-key-file <(echo "$SPARKLE_EDDSA_KEY"))
          echo "SPARKLE_SIGNATURE<<EOF" >> $GITHUB_ENV
          echo "$SIGNATURE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Get file size
          ZIP_SIZE=$(stat -f%z "$ZIP_PATH")
          echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_ENV

      - name: Create GitHub Release
        run: |
          TAG="${{ github.ref_name }}"
          ASSET_DMG="build/Build/Products/Release/TypeWhisper-${TAG}.dmg"
          ASSET_ZIP="build/Build/Products/Release/TypeWhisper-${TAG}.zip"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Uploading assets..."
            gh release upload "$TAG" "$ASSET_DMG" "$ASSET_ZIP" --clobber
          else
            echo "Creating release $TAG..."
            gh release create "$TAG" "$ASSET_DMG" "$ASSET_ZIP" --generate-notes
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate and Deploy Appcast
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          DOWNLOAD_URL="https://github.com/TypeWhisper/typewhisper-mac/releases/download/${TAG}/TypeWhisper-${TAG}.zip"
          PUB_DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")

          # Parse edSignature and length from sign_update output
          # Format: sparkle:edSignature="..." length="..."
          ED_SIGNATURE=$(echo "$SPARKLE_SIGNATURE" | sed -n 's/.*sparkle:edSignature="\([^"]*\)".*/\1/p')
          ED_LENGTH=$(echo "$SPARKLE_SIGNATURE" | sed -n 's/.*length="\([^"]*\)".*/\1/p')

          # If parsing fails, fall back to ZIP_SIZE
          if [ -z "$ED_LENGTH" ]; then
            ED_LENGTH="$ZIP_SIZE"
          fi

          cat > /tmp/appcast.xml <<APPCAST_EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>TypeWhisper Updates</title>
              <language>en</language>
              <item>
                <title>Version ${VERSION}</title>
                <pubDate>${PUB_DATE}</pubDate>
                <sparkle:version>${VERSION}</sparkle:version>
                <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
                <enclosure url="${DOWNLOAD_URL}" sparkle:edSignature="${ED_SIGNATURE}" length="${ED_LENGTH}" type="application/octet-stream"/>
              </item>
            </channel>
          </rss>
          APPCAST_EOF

          # Deploy to gh-pages branch
          cd "$GITHUB_WORKSPACE"
          git fetch origin gh-pages || true

          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git worktree add -B gh-pages /tmp/gh-pages origin/gh-pages
          else
            git worktree add --detach /tmp/gh-pages
            cd /tmp/gh-pages
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            cd "$GITHUB_WORKSPACE"
          fi

          cp /tmp/appcast.xml /tmp/gh-pages/appcast.xml
          cd /tmp/gh-pages
          git add appcast.xml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update appcast for ${TAG}" || echo "No changes to commit"
          git push origin gh-pages
